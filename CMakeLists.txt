cmake_minimum_required(VERSION 3.15.0)
project ("FreeRTOS TCP/IP Mayhem Harnesses" VERSION 1.0.0 LANGUAGES C)

add_library(freertos_config INTERFACE)
target_include_directories(freertos_config SYSTEM INTERFACE
    ConfigFiles
)


set( SANITIZE "" CACHE STRING "Comma-separated list of compiler sanitizers to enable; empty string disables." )

if( NOT ${SANITIZE} STREQUAL "" )
  add_compile_options(-fsanitize=${SANITIZE})
  add_link_options(-fsanitize=${SANITIZE})
endif()
add_compile_options(-g)
add_subdirectory(port)

set( FREERTOS_PORT A_CUSTOM_PORT)
set( FREERTOS_PLUS_TCP_NETWORK_IF "LOOPBACK" CACHE STRING "" FORCE)

add_subdirectory(freertos_kernel)
add_subdirectory(freertos_plus_tcp)
target_compile_options(freertos_plus_tcp PUBLIC -g)
add_subdirectory(driver)
add_subdirectory(middleware)

function(create_harness name)
  add_executable(${name} harnesses/${name}/harness.c)
  target_link_libraries(${name} driver middleware)
  set(workdir ${CMAKE_BINARY_DIR}/harnesses/${name})
  set_target_properties(${name} PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY ${workdir}/root)
  file(GENERATE
    OUTPUT ${workdir}/Mayhemfile
    CONTENT "# autogenerated by create_harness
project: freertos
target: ${name}
duration: 3600
cmds:
  - cmd: /${name} @@
")

  # probably it is better to use mayhem package here.
  if("${SANITIZE}" STREQUAL "address")
    file(GLOB SANINTIZERS "/usr/lib/x86_64-linux-gnu/libasan.so.*")
    file(
      COPY ${SANITIZERS}
      DESTINATION ${workdir}/root/lib
      FOLLOW_SYMLINK_CHAIN)
  endif()
  add_custom_target(run_${name}
    DEPENDS ${name}
    COMMAND mayhem run ${workdir}
  )
endfunction()

# harnesses
create_harness(icmp)
create_harness(arp)
create_harness(udp)
create_harness(tcp)
create_harness(dns)
create_harness(netbios)
create_harness(dns-handle-packet)
create_harness(nd-icmp-v6)
create_harness(nd-check-resolution)
create_harness(full-stack)
